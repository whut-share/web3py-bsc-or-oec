from oec.isl_utils import Isl
from oec.oec_key import AdminKey

from datetime import datetime,timedelta
import time

isl = Isl()

# isl.web3Utils.get_bytes4_abi('[{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"addBlackList","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_addMinter","type":"address"}],"name":"addMinter","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"},{"internalType":"uint256","name":"_time","type":"uint256"}],"name":"addUserDefTime","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"attackUser","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_islandShip","type":"address"},{"internalType":"address","name":"_islandMaster","type":"address"},{"internalType":"address","name":"_islanMasterdFactory","type":"address"},{"internalType":"address","name":"_islandComputerOther","type":"address"},{"internalType":"address","name":"_islandMasterReward","type":"address"},{"internalType":"address","name":"_islandProps","type":"address"},{"internalType":"address","name":"_islandFarm","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"islAmount","type":"uint256"},{"indexed":true,"internalType":"uint256","name":"exp","type":"uint256"},{"indexed":true,"internalType":"address","name":"defender","type":"address"},{"indexed":false,"internalType":"address","name":"attacker","type":"address"},{"indexed":false,"internalType":"uint256","name":"cap","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"def","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"wood","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"stone","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"gemId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"gemCount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"propId1","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"propCount1","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"propId2","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"propCount2","type":"uint256"}],"name":"AttackUser","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"_propId","type":"uint256"},{"indexed":true,"internalType":"uint256","name":"_propNum","type":"uint256"}],"name":"AttackUserBonus","type":"event"},{"inputs":[{"internalType":"address","name":"_delMinter","type":"address"}],"name":"delMinter","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"},{"internalType":"uint256","name":"_exp","type":"uint256"},{"internalType":"address","name":"_user","type":"address"},{"internalType":"uint256","name":"_cap","type":"uint256"},{"internalType":"uint256","name":"_def","type":"uint256"},{"internalType":"uint256[5]","name":"_propIds","type":"uint256[5]"},{"internalType":"uint256[5]","name":"_counts","type":"uint256[5]"}],"name":"emitAttackUser","outputs":[],"stateMutability":"nonpayable","type":"function"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"removeBlackList","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_islandShip","type":"address"},{"internalType":"address","name":"_islandMaster","type":"address"},{"internalType":"address","name":"_islanMasterdFactory","type":"address"},{"internalType":"address","name":"_islandComputerOther","type":"address"},{"internalType":"address","name":"_islandMasterReward","type":"address"},{"internalType":"address","name":"_islandProps","type":"address"},{"internalType":"address","name":"_islandFarm","type":"address"}],"name":"setAddr","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_baseProp","type":"uint256"},{"internalType":"uint256","name":"_baseConsu","type":"uint256"},{"internalType":"uint256","name":"_startTime","type":"uint256"}],"name":"setBaseParam","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_fightTime","type":"uint256"},{"internalType":"uint256","name":"_baseDefTime","type":"uint256"},{"internalType":"uint256","name":"_maxCool","type":"uint256"},{"internalType":"uint256","name":"_maxBonus","type":"uint256"},{"internalType":"uint256","name":"_maxGap","type":"uint256"}],"name":"setBaseSetting","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256[]","name":"_levels","type":"uint256[]"},{"internalType":"uint256[]","name":"_exps","type":"uint256[]"}],"name":"setLevelToFightExp","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"setPause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"setPaused","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"},{"internalType":"uint256","name":"_time","type":"uint256"}],"name":"subUserFightTime","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"baseConsu","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"baseDefTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"baseFightTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"},{"internalType":"uint256","name":"cap","type":"uint256"},{"internalType":"uint256","name":"def","type":"uint256"}],"name":"canAttackUser","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"defLastTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"fightLastTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_index","type":"uint256"}],"name":"getMinter","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMinterLength","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getNow","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserBaseTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserEnergy","outputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"isBlack","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"isMinter","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"levelToFightExp","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxBonus","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxCool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxGap","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"startTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"userMedal","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}]')
# tm = isl.gamePlunderContract.functions.userMedal('0x1C697f76a917E8995b93B0cD5b7F7BfF35daB93B').call()
# print(tm)

# 获取key
key = AdminKey.KEY.value
# 获取账号
account = isl.web3Utils.get_account(key)
# 获取上一次进行游戏时间
tm = isl.gameHarvestContract.functions.islLastTime(account.address).call()
# 下一次进行游戏时间
timeObj = datetime.fromtimestamp(tm) + timedelta(hours=3)
# 转换成时间戳
timeMk = int(timeObj.timestamp())
# 获取当前时间
timeMkNow = int(time.time())
# 判断当前时间大于游戏时间开始游戏
if timeMkNow > timeMk:
    # 获取key
    key = AdminKey.KEY.value
    # 获取账号
    account = isl.web3Utils.get_account(key)
    # 获取交易次数
    nonce = isl.web3Utils.get_nonce(account.address)
    # 发送交易
    tx = isl.play_game_harvest(key, nonce)
    print(tx)
